<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confirm Download - Yobest Studio</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-kqNfk8EL0Vsx5pqskqQ57pq+BwR55rYwtVmswqLxMQ52R9ETg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;700&display=swap" rel="stylesheet">
</head>
<body>
    <header class="header-animate">
        <div class="container">
            <h1 class="title-frame"><a href="index.html" class="site-name">Yobest Studio<span class="highlight"></span></a></h1>
            <nav class="nav-container">
                <a href="blog.html" class="nav-btn">Blog</a>
                <a href="contact.html" class="nav-btn">Contact</a>
                <a href="index.html" class="nav-btn">Home</a>
                <a href="ai.html" class="nav-btn">AI Tools</a>
                <a href="https://discord.gg/jKASqrc7H3" target="_blank" class="btn socialbtn"><i class="fab fa-discord"></i> Discord</a>
                <a href="https://x.com/Yobest_BYTR" target="_blank" class="btn socialbtn"><i class="fab fa-x"></i> X</a>
                <a href="#" id="login-btn" class="btn socialbtn" onclick="toggleLoginForm()">Login</a>
                <a href="#" id="account-btn" class="btn socialbtn" onclick="toggleAccountForm()" style="display: none;">Account</a>
            </nav>
        </div>
    </header>

    <div id="login-form" class="modal">
        <div class="modal-content auth-modal">
            <span class="close-btn" onclick="document.getElementById('login-form').style.display='none'">×</span>
            <h2 class="modal-title">Login</h2>
            <form id="login-form-content" onsubmit="handleLogin(event)">
                <input type="email" id="email-login" placeholder="Email" required class="auth-input">
                <input type="password" id="password-login" placeholder="Password" required class="auth-input">
                <button type="submit" class="btn actionbtn">Login</button>
                <p class="or-divider">OR</p>
                <a href="#" class="btn google-btn"><i class="fab fa-google"></i> Login with Google</a>
                <p class="auth-link">Not registered? <a href="#" onclick="toggleSignupForm()">Sign Up</a></p>
                <div id="login-error" class="reaction-text" style="display: none; color: #ff0000;"></div>
            </form>
        </div>
    </div>

    <div id="signup-form" class="modal" style="display: none;">
        <div class="modal-content auth-modal">
            <span class="close-btn" onclick="document.getElementById('signup-form').style.display='none'">×</span>
            <h2 class="modal-title">Sign Up</h2>
            <form id="signup-form-content" onsubmit="handleSignup(event)">
                <input type="email" id="email-signup" placeholder="Email" required class="auth-input">
                <input type="password" id="password-signup" placeholder="Password" required class="auth-input">
                <input type="password" id="confirm-password" placeholder="Confirm Password" required class="auth-input">
                <button type="submit" class="btn actionbtn">Sign Up</button>
                <p class="auth-link">Already registered? <a href="#" onclick="toggleLoginForm()">Login</a></p>
                <div id="signup-error" class="reaction-text" style="display: none; color: #ff0000;"></div>
            </form>
        </div>
    </div>

    <div id="account-form" class="modal" style="display: none;">
        <div class="modal-content auth-modal">
            <span class="close-btn" onclick="document.getElementById('account-form').style.display='none'">×</span>
            <h2 class="modal-title">Account</h2>
            <form id="account-form-content" onsubmit="updateAccount(event)">
                <input type="email" id="email-account" placeholder="Email" required class="auth-input">
                <input type="password" id="password-account" placeholder="New Password" required class="auth-input">
                <button type="submit" class="btn actionbtn">Update Account</button>
                <button type="button" onclick="viewAccountInfo()" class="btn actionbtn">View Info</button>
                <button type="button" onclick="logout()" class="btn actionbtn">Logout</button>
                <div id="account-error" class="reaction-text" style="display: none; color: #ff0000;"></div>
            </form>
        </div>
    </div>

    <section class="confirm-section animate-section" style="background: linear-gradient(135deg, #1a1a3a, #2a2a5a);">
        <div class="container">
            <h2 class="title-frame animate-text">Downloading: <span id="video-title"></span></h2>
            <p class="reaction-text animate-text">Complete the steps to continue</p>
            <div class="confirmation-tasks" id="tasks-container">
                <div class="task-card" id="subscribe-task">
                    <div class="task-content">
                        <i class="fab fa-youtube icon"></i>
                        <span>Subscribe on YouTube</span>
                    </div>
                    <button class="task-button" onclick="handleSubscribe()">Verify</button>
                </div>
                <div class="task-card" id="like-comment-task">
                    <div class="task-content">
                        <i class="fab fa-youtube icon"></i>
                        <span>Like & Comment on YouTube</span>
                    </div>
                    <button class="task-button" onclick="handleLikeComment()">Verify</button>
                </div>
                <div class="task-card" id="twitter-task">
                    <div class="task-content">
                        <i class="fab fa-x icon"></i>
                        <span>Follow on Twitter</span>
                    </div>
                    <button class="task-button" onclick="handleTwitter()">Verify</button>
                </div>
            </div>
            <div id="loading-spinner" class="loading-spinner" style="display: none;">
                <div class="spinner"></div>
                <p>Waiting for verification...</p>
            </div>
            <div id="success-message" class="success-message" style="display: none;">
                <div class="task-card completed">
                    <div class="task-content">
                        <i class="fas fa-check checkmark"></i>
                        <span>All steps have been completed</span>
                    </div>
                </div>
                <p class="success-text">Well done, now you can download the game</p>
                <a id="download-link" href="#" class="btn actionbtn animate-btn" style="display: none;">Download Game</a>
            </div>
            <div id="confirm-error" class="reaction-text" style="display: none; color: #ff0000;"></div>
        </div>
    </section>

    <footer class="animate-section">
        <div class="container">
            <p class="animate-text">© 2025 Yobest Studio. All Rights Reserved.</p>
        </div>
    </footer>

    <script src="script.js"></script>
    <script>
        // Define CHANNEL_ID globally
        const CHANNEL_ID = 'UCsV3X3EyEowLEdRW1RileuA'; // Your YouTube channel ID

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const videoId = urlParams.get('videoId');
            const title = decodeURIComponent(urlParams.get('title') || '');
            document.getElementById('download-link').dataset.videoId = videoId;
            document.getElementById('download-link').dataset.title = title;
            document.getElementById('video-title').textContent = title;
            updateNavButtons();
            initializeTaskChecks();
        });

        async function initializeTaskChecks() {
            const videoId = document.getElementById('download-link').dataset.videoId;
            const API_KEY = 'AIzaSyChwoHXMqlbmAfeh4lbRUFWx2HjIZ6VV2k'; // Replace with your actual YouTube API key

            // Attempt to auto-check subscription (simplified; requires OAuth for full accuracy)
            try {
                const response = await fetch(`https://www.googleapis.com/youtube/v3/subscriptions?part=snippet&forChannelId=${CHANNEL_ID}&mine=true&key=${API_KEY}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.items && data.items.length > 0) {
                        document.getElementById('subscribe-task').classList.add('completed');
                    }
                }
            } catch (error) {
                console.error('Subscription check failed:', error);
            }

            // Auto-check like and comment (simulated site verification; requires OAuth for real data)
            try {
                const videoResponse = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=statistics&id=${videoId}&key=${API_KEY}`);
                if (videoResponse.ok) {
                    const videoData = await videoResponse.json();
                    if (videoData.items && videoData.items.length > 0) {
                        const stats = videoData.items[0].statistics;
                        const userLiked = confirm('Have you liked the video on YouTube? The site will verify this action.');
                        const userCommented = confirm('Have you commented on the video on YouTube? The site will verify this action.');
                        if (userLiked && userCommented && stats.likeCount && stats.commentCount) { // Simplified verification
                            document.getElementById('like-comment-task').classList.add('completed');
                        } else {
                            alert('Please like and comment on the video, then retry verification.');
                        }
                    }
                }
            } catch (error) {
                console.error('Like/Comment check failed:', error);
            }

            checkAllTasks();
        }

        async function handleSubscribe() {
            const task = document.getElementById('subscribe-task');
            const button = task.querySelector('.task-button');
            const loadingSpinner = document.getElementById('loading-spinner');
            const errorDiv = document.getElementById('confirm-error');
            const CHANNEL_URL = 'https://www.youtube.com/channel/' + CHANNEL_ID;

            loadingSpinner.style.display = 'block';
            button.disabled = true;

            // Redirect to YouTube channel in a new window/tab
            const subscribeWindow = window.open(CHANNEL_URL, '_blank');
            if (!subscribeWindow) {
                errorDiv.textContent = 'Popup blocked. Please allow popups and try again.';
                errorDiv.style.display = 'block';
                setTimeout(() => errorDiv.style.display = 'none', 3000);
                loadingSpinner.style.display = 'none';
                button.disabled = false;
                return;
            }

            // Poll for subscription status or allow user confirmation
            let attempts = 0;
            const maxAttempts = 30; // Increased to 30 seconds for user interaction
            const checkInterval = setInterval(async () => {
                try {
                    const API_KEY = 'AIzaSyChwoHXMqlbmAfeh4lbRUFWx2HjIZ6VV2k'; // Replace with your actual YouTube API key
                    const response = await fetch(`https://www.googleapis.com/youtube/v3/subscriptions?part=snippet&forChannelId=${CHANNEL_ID}&mine=true&key=${API_KEY}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.items && data.items.length > 0) {
                            clearInterval(checkInterval);
                            task.classList.add('completed');
                            button.textContent = 'Verified';
                            button.disabled = true;
                            checkAllTasks();
                            loadingSpinner.style.display = 'none';
                            if (subscribeWindow) subscribeWindow.close();
                            return;
                        }
                    }
                    // Allow user to confirm subscription or no account
                    const userSubscribed = confirm('Have you subscribed to the channel? If not, or if you don’t have a YouTube account, click "Cancel" to proceed.');
                    if (userSubscribed) {
                        clearInterval(checkInterval);
                        task.classList.add('completed');
                        button.textContent = 'Verified';
                        button.disabled = true;
                        checkAllTasks();
                        loadingSpinner.style.display = 'none';
                        if (subscribeWindow) subscribeWindow.close();
                        return;
                    }
                } catch (error) {
                    console.error('Subscription verification failed:', error);
                }
                attempts++;
                if (attempts >= maxAttempts) {
                    clearInterval(checkInterval);
                    errorDiv.textContent = 'Subscription verification timed out. Please subscribe or confirm and try again.';
                    errorDiv.style.display = 'block';
                    setTimeout(() => errorDiv.style.display = 'none', 3000);
                    loadingSpinner.style.display = 'none';
                    button.disabled = false;
                }
            }, 1000); // Check every second
        }

        async function handleLikeComment() {
            const task = document.getElementById('like-comment-task');
            const button = task.querySelector('.task-button');
            const loadingSpinner = document.getElementById('loading-spinner');
            const errorDiv = document.getElementById('confirm-error');
            const videoId = document.getElementById('download-link').dataset.videoId;
            const VIDEO_URL = `https://www.youtube.com/watch?v=${videoId}`;

            loadingSpinner.style.display = 'block';
            button.disabled = true;

            // Redirect to YouTube video in a new window/tab
            const likeCommentWindow = window.open(VIDEO_URL, '_blank');
            if (!likeCommentWindow) {
                errorDiv.textContent = 'Popup blocked. Please allow popups and try again.';
                errorDiv.style.display = 'block';
                setTimeout(() => errorDiv.style.display = 'none', 3000);
                loadingSpinner.style.display = 'none';
                button.disabled = false;
                return;
            }

            // Poll for like and comment status or simulate site verification
            let attempts = 0;
            const maxAttempts = 30; // Increased to 30 seconds for user interaction
            const checkInterval = setInterval(async () => {
                try {
                    const API_KEY = 'AIzaSyChwoHXMqlbmAfeh4lbRUFWx2HjIZ6VV2k'; // Replace with your actual YouTube API key
                    const response = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=statistics&id=${videoId}&key=${API_KEY}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.items && data.items.length > 0) {
                            const stats = data.items[0].statistics;
                            const userLiked = confirm('Have you liked the video on YouTube? The site will verify this action based on video stats.');
                            const userCommented = confirm('Have you commented on the video on YouTube? The site will verify this action based on video stats.');
                            if (userLiked && userCommented && stats.likeCount && stats.commentCount) {
                                clearInterval(checkInterval);
                                task.classList.add('completed');
                                button.textContent = 'Verified';
                                button.disabled = true;
                                checkAllTasks();
                                loadingSpinner.style.display = 'none';
                                if (likeCommentWindow) likeCommentWindow.close();
                                return;
                            } else {
                                alert('Please like and comment on the video, then retry verification.');
                            }
                        }
                    }
                } catch (error) {
                    console.error('Like/Comment verification failed:', error);
                }
                attempts++;
                if (attempts >= maxAttempts) {
                    clearInterval(checkInterval);
                    errorDiv.textContent = 'Like/Comment verification timed out. Please like, comment, or confirm and try again.';
                    errorDiv.style.display = 'block';
                    setTimeout(() => errorDiv.style.display = 'none', 3000);
                    loadingSpinner.style.display = 'none';
                    button.disabled = false;
                }
            }, 1000); // Check every second
        }

        async function handleTwitter() {
            const task = document.getElementById('twitter-task');
            const button = task.querySelector('.task-button');
            const loadingSpinner = document.getElementById('loading-spinner');
            const errorDiv = document.getElementById('confirm-error');
            const TWITTER_URL = 'https://x.com/Yobest_BYTR';

            loadingSpinner.style.display = 'block';
            button.disabled = true;

            // Redirect to Twitter profile in a new window/tab
            const twitterWindow = window.open(TWITTER_URL, '_blank');
            if (!twitterWindow) {
                errorDiv.textContent = 'Popup blocked. Please allow popups and try again.';
                errorDiv.style.display = 'block';
                setTimeout(() => errorDiv.style.display = 'none', 3000);
                loadingSpinner.style.display = 'none';
                button.disabled = false;
                return;
            }

            // Poll for follow status or allow user confirmation
            let attempts = 0;
            const maxAttempts = 30; // Increased to 30 seconds for user interaction
            const checkInterval = setInterval(() => {
                const userFollows = confirm('Have you followed @Yobest_BYTR on Twitter? If not, or if you don’t have a Twitter account, click "Cancel" to proceed.');
                if (userFollows || !userFollows) {
                    clearInterval(checkInterval);
                    task.classList.add('completed');
                    button.textContent = 'Verified' + (!userFollows ? ' (No Account)' : '');
                    button.disabled = true;
                    checkAllTasks();
                    loadingSpinner.style.display = 'none';
                    if (twitterWindow) twitterWindow.close();
                }
                attempts++;
                if (attempts >= maxAttempts) {
                    clearInterval(checkInterval);
                    errorDiv.textContent = 'Follow verification timed out. Please follow or confirm and try again.';
                    errorDiv.style.display = 'block';
                    setTimeout(() => errorDiv.style.display = 'none', 3000);
                    loadingSpinner.style.display = 'none';
                    button.disabled = false;
                }
            }, 1000); // Check every second
        }

        function checkAllTasks() {
            const tasks = document.querySelectorAll('.task-card');
            const allCompleted = Array.from(tasks).every(task => task.classList.contains('completed'));
            const successMessage = document.getElementById('success-message');
            const downloadLink = document.getElementById('download-link');
            const videoId = downloadLink.dataset.videoId;
            const title = downloadLink.dataset.title;

            if (allCompleted) {
                successMessage.style.display = 'block';
                const gameFiles = {
                    'Toilet tower defense uncopylocked UP4⚔ By BYTR': 'https://raw.githubusercontent.com/Yobest-Bytr/BYTR-games/refs/heads/main/Toilet%20tower%20defense%20uncopylocked%20UP4%E2%9A%94%20By%20BYTR.rar'
                    // Add more mappings for other games as needed
                };
                downloadLink.href = gameFiles[title] || '#';
                downloadLink.style.display = 'inline-block';
            } else {
                successMessage.style.display = 'none';
                downloadLink.style.display = 'none';
            }
        }
    </script>
</body>
</html>