<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Details - Yobest Studio</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2925220406728611"
            crossorigin="anonymous"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Poppins Font -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;700&display=swap" rel="stylesheet">
    <!-- Prism.js for syntax highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="header-animate">
        <div class="container">
            <h1 class="title-frame"><a href="index.html" class="site-name">Yobest Studio<span class="highlight"></span></a></h1>
            <nav class="nav-container">
                <a href="blog.html" class="nav-btn">Blog</a>
                <a href="contact.html" class="nav-btn">Contact</a>
                <a href="index.html" class="nav-btn">Home</a>
                <a href="ai.html" class="nav-btn">AI Tools</a>
                <a href="communication.html" class="nav-btn">Communication</a>
                <a href="https://discord.gg/jKASqrc7H3" target="_blank" class="btn socialbtn"><i class="fab fa-discord"></i> Discord</a>
                <a href="https://x.com/Yobest_BYTR" target="_blank" class="btn socialbtn"><i class="fab fa-x"></i> X</a>
            </nav>
        </div>
    </header>

    <!-- Game Details -->
    <section class="game-details animate-section" style="background: linear-gradient(135deg, #1a1a3a, #2a2a5a);">
        <div class="container">
            <h2 id="game-title" class="title-frame animate-text">Loading...</h2>
            <div class="video-container">
                <iframe id="game-video" width="100%" height="315" frameborder="0" allowfullscreen></iframe>
                <div class="video-stats">
                    <span id="likes"><i class="fas fa-thumbs-up"></i> Loading likes...</span>
                    <span id="views"><i class="fas fa-eye"></i> Loading views...</span>
                </div>
                <p id="game-description" class="reaction-text animate-text">Loading description...</p>
                <div class="button-group">
                    <a id="download-btn" href="#" class="btn actionbtn animate-btn">Download Game</a>
                    <input type="file" id="game-file-upload" accept=".rar,.rbxl,.rbxlx" onchange="uploadGameFile(this)" class="game-file-upload">
                    <a href="index.html" class="btn actionbtn animate-btn">Back to Home</a>
                </div>
            </div>
            <div class="game-buttons">
                <a href="https://discord.gg/jKASqrc7H3" target="_blank" class="btn socialbtn animate-btn"><i class="fab fa-discord"></i> Discord</a>
                <a href="https://x.com/Yobest_BYTR" target="_blank" class="btn socialbtn animate-btn"><i class="fab fa-x"></i> X</a>
            </div>
            <!-- Comments Section -->
            <div class="comments-section">
                <h3 class="title-frame animate-text">Comments</h3>
                <div class="comments-container">
                    <div class="youtube-comments">
                        <h4 class="animate-text">YouTube Comments</h4>
                        <div id="youtube-comments-list"></div>
                    </div>
                    <div class="site-comments">
                        <h4 class="animate-text">Site Comments</h4>
                        <div id="site-comments-list"></div>
                        <div class="button-group">
                            <input type="text" id="comment-input" placeholder="Add a comment..." class="chat-input" required>
                            <button onclick="postComment()" class="btn actionbtn animate-btn">Post</button>
                        </div>
                    </div>
                </div>
                <p class="animate-text">Page Visitors: <span id="page-visitors"></span></p>
            </div>
        </div>
    </section>

    <!-- Channel Videos Section -->
    <section class="channel-videos animate-section">
        <div class="container">
            <h2 class="title-frame animate-text">More from Yobest Studio</h2>
            <div class="video-grid" id="video-grid">
                <!-- Videos will be inserted here dynamically -->
            </div>
        </div>
    </section>

    <!-- Ad Section -->
    <section class="ad-section">
        <div class="container">
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-2925220406728611"
                 data-ad-slot="YYYYYYYYYY"
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
            <script>
                (adsbygoogle = window.adsbygoogle || []).push({});
            </script>
        </div>
    </section>

    <!-- Footer -->
    <footer class="animate-section">
        <div class="container">
            <p class="animate-text">Â© 2025 Yobest Studio. All Rights Reserved.</p>
        </div>
    </footer>

    <!-- Chat Box -->
    <div id="chat-box" class="animate-section">
        <h3 class="animate-text"><i class="fas fa-comments"></i> Community Chat</h3>
        <div id="chat-messages"></div>
        <div class="button-group">
            <input type="text" id="chat-input" placeholder="Say something..." class="chat-input">
            <button onclick="sendMessage()" class="btn actionbtn animate-btn">Send</button>
        </div>
    </div>

    <script src="script.ts"></script>
    <script>
        // Ensure script.ts is loaded and DOM is ready before executing functions
        // Note: For production, compile script.ts to script.js and reference script.js instead
        window.onload = function(): void {
            console.log('Checking if functions are defined...');
            if (typeof trackVisitor === 'function' && 
                typeof trackPageVisitors === 'function' && 
                typeof displayCounters === 'function') {
                console.log('All functions defined, executing...');
                trackVisitor();
                trackPageVisitors();
                displayCounters();
            } else {
                console.error('One or more functions are not defined. Ensure script.ts is compiled and loaded correctly. Defined functions:', {
                    trackVisitor: typeof trackVisitor,
                    trackPageVisitors: typeof trackPageVisitors,
                    displayCounters: typeof displayCounters
                });
            }

            // Load game details from localStorage and YouTube API
            const urlParams: URLSearchParams = new URLSearchParams(window.location.search);
            const gameId: string | null = urlParams.get('id');
            const videos: any[] = JSON.parse(localStorage.getItem('channelVideos') || '[]');
            const API_KEY: string = 'AIzaSyAHLMunc1uf9O61UxbTGYj4r8cixc13Eq0';
            const PLAYLIST_ID: string = 'UUsV3X3EyEowLEdRW1RileuA'; // Updated playlist ID

            if (gameId && videos.length > 0 && parseInt(gameId) >= 0 && parseInt(gameId) < videos.length) {
                const video = videos[parseInt(gameId)];
                const videoId: string = video.snippet.resourceId.videoId;
                const title: string = video.snippet.title;
                const description: string = video.snippet.description || "No description available.";

                // Set iframe source for direct YouTube viewing
                const gameTitle = document.getElementById('game-title') as HTMLElement;
                const gameVideo = document.getElementById('game-video') as HTMLIFrameElement;
                const gameDescription = document.getElementById('game-description') as HTMLElement;
                gameTitle.textContent = title;
                gameVideo.src = `https://www.youtube.com/embed/${videoId}`;
                gameDescription.textContent = description;

                // Update download button to redirect to confirm.html
                const downloadBtn = document.getElementById('download-btn') as HTMLAnchorElement;
                downloadBtn.href = `confirm.html?videoId=${videoId}&title=${encodeURIComponent(title)}`;

                // Fade in the title
                gameTitle.classList.add('animate-text');

                // Fetch video statistics (likes and views)
                fetch(`https://www.googleapis.com/youtube/v3/videos?part=statistics&id=${videoId}&key=${API_KEY}`)
                    .then(response => response.json())
                    .then((data: any) => {
                        if (data.items && data.items.length > 0) {
                            const stats = data.items[0].statistics;
                            const likesElement = document.getElementById('likes') as HTMLElement;
                            const viewsElement = document.getElementById('views') as HTMLElement;
                            likesElement.innerHTML = `<i class="fas fa-thumbs-up"></i> ${stats.likeCount || 0} Likes`;
                            viewsElement.innerHTML = `<i class="fas fa-eye"></i> ${stats.viewCount || 0} Views`;
                        } else {
                            console.warn('No statistics data found for video:', videoId);
                            const likesElement = document.getElementById('likes') as HTMLElement;
                            const viewsElement = document.getElementById('views') as HTMLElement;
                            likesElement.innerHTML = `<i class="fas fa-thumbs-up"></i> N/A Likes`;
                            viewsElement.innerHTML = `<i class="fas fa-eye"></i> N/A Views`;
                        }
                    })
                    .catch((error: Error) => {
                        console.error('Error fetching video stats:', error);
                        const likesElement = document.getElementById('likes') as HTMLElement;
                        const viewsElement = document.getElementById('views') as HTMLElement;
                        likesElement.innerHTML = `<i class="fas fa-thumbs-up"></i> Error`;
                        viewsElement.innerHTML = `<i class="fas fa-eye"></i> Error`;
                    });

                // Load YouTube comments
                loadYouTubeComments(videoId);

                // Load site comments
                loadSiteComments(videoId);

                // Load or set game file link
                const gameFile: string = localStorage.getItem(`gameFile_${videoId}`) || '';
                if (gameFile) {
                    downloadBtn.href = gameFile;
                }
            } else {
                const gameTitle = document.getElementById('game-title') as HTMLElement;
                const gameVideo = document.getElementById('game-video') as HTMLIFrameElement;
                const downloadBtn = document.getElementById('download-btn') as HTMLAnchorElement;
                const gameDescription = document.getElementById('game-description') as HTMLElement;
                gameTitle.textContent = 'Game Not Found';
                gameVideo.style.display = 'none';
                downloadBtn.style.display = 'none';
                gameDescription.textContent = 'No game data available.';
                gameTitle.classList.add('animate-text');
            }

            // Load channel videos
            const videoGrid = document.getElementById('video-grid') as HTMLElement;
            if (videoGrid) {
                videos.forEach((item: any, index: number) => {
                    if (index != (gameId ? parseInt(gameId) : -1)) { // Exclude the current game video
                        const videoId: string = item.snippet.resourceId.videoId;
                        const title: string = item.snippet.title;
                        const thumbnail: string = item.snippet.thumbnails?.maxres?.url || 'https://via.placeholder.com/150';

                        if (!videoId || !title || !thumbnail) {
                            console.warn(`Skipping video at index ${index} due to missing data.`);
                            return;
                        }

                        const card = document.createElement('div');
                        card.className = 'video-card animate-card';
                        card.innerHTML = `
                            <a href="game.html?id=${index}">
                                <img src="${thumbnail}" alt="${title}">
                                <h3 class="animate-text">${title}</h3>
                            </a>
                        `;
                        videoGrid.appendChild(card);
                    }
                });
            } else {
                console.error('Video grid element not found in game.html.');
            }
        };

        // Upload game file function (including .rar, .rbxl, and .rbxlx)
        function uploadGameFile(input: HTMLInputElement): void {
            console.log('uploadGameFile called');
            const file: File | null = input.files?.[0] || null;
            if (file && (file.type === 'application/x-rar-compressed' || file.name.endsWith('.rbxl') || file.name.endsWith('.rbxlx'))) {
                const formData = new FormData();
                formData.append('file', file);

                // Simulate file upload (replace with actual backend endpoint)
                const reader = new FileReader();
                reader.onload = function(e: ProgressEvent<FileReader>): void {
                    const fileUrl: string = e.target?.result as string; // Base64 or Blob URL for local testing
                    const urlParams: URLSearchParams = new URLSearchParams(window.location.search);
                    const gameId: string | null = urlParams.get('id');
                    const videoId: string | undefined = JSON.parse(localStorage.getItem('channelVideos') || '[]')[gameId ? parseInt(gameId) : -1]?.snippet.resourceId.videoId;
                    if (videoId) {
                        localStorage.setItem(`gameFile_${videoId}`, fileUrl);
                        const downloadBtn = document.getElementById('download-btn') as HTMLAnchorElement;
                        if (downloadBtn) {
                            downloadBtn.href = fileUrl;
                            alert(`Game file (${file.name}) uploaded successfully! Click "Download Game" to access.`);
                        } else {
                            console.error('Download button not found.');
                        }
                    }
                };
                reader.readAsDataURL(file);
            } else {
                alert('Please upload a .rar, .rbxl, or .rbxlx file.');
            }
        }
    </script>
</body>
</html>
